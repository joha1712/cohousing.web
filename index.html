<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bofællesskab</title>
    <link rel="stylesheet" href="styles/bulma/darkly/bulmaswatch_v0.7.1.min.css">
    <link rel="stylesheet" href="styles/style.css">
    
    <script src="scripts/axios/axios_v0.18.0.js"></script>
    <script defer src="scripts/fontawesome/fontawesome_v5.0.7.min.js"></script>    
    <script src="scripts/vue/vue_v2.5.16.js"></script> 
    <script src="config.js"> type="module"</script> 
    
  </head>
  
  <body>
    <div id="app"> 
        
        <section class="section">
            <div class="container has-text-centered">
                <h1 class="title is-hidden-mobile-bottommarginfix">
                    {{ pageTitle }}
                </h1>
                <p class="subtitle is-hidden-mobile">
                    {{ pageSubtitle }}
                </p>          
            </div>

            <nav class="pagination is-hidden-mobile" role="navigation" aria-label="pagination">
                <a class="pagination-previous" @click="previous()">Forrige uge</a>
                <a class="pagination-next" @click="next()">Næste uge</a>
            </nav>

            <nav class="pagination is-visible-mobile-only" role="navigation" aria-label="pagination">
                <a class="pagination-previous" @click="previous()">Forrige</a>
                <a class="pagination-next" @click="next()">Næste</a>
            </nav>

        </section>       

        <section class="section">     

            <div class="tile is-ancestor">                
                <div class="meal-tile tile" v-for="(commonMeal, idx2) in commonMeals" :class=" idx2 === 0 ? '' : 'is-hidden-mobile' ">
                    <div class="tile is-child box" >
                        <div class="box has-text-centered meal-header-box" :class="calcMealTitleClass(commonMeal.chefs)">
                            <p class="title is-4">{{ commonMeal.dayName }}</p>
                            <p class="subtitle is-6">{{ commonMeal.dateName }}</p>                            
                        </div>

                        <div class="box meal-chef-box">                                                            
                                
                            <div class="meal-chef-row columns is-mobile is-marginless" v-for="(chef, idx) in commonMeal.chefs">                                
                                
                                <div class="column is-paddingless is-1" >
                                    <span v-show="chef.personId != null" class="icon is-small" style="vertical-align:bottom;">
                                          <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>
                            
                                <div class="column is-paddingless is-10" >
                                    <div class="field">
                                        <p class="control is-expanded has-icons-left">
                                            <span class="select is-fullwidth">
                                                <select v-model="chef.personId" @change="saveChef(chef)">
                                                    <option :value="null">Vælg {{ idx + 1 }}. kok ...</option>
                                                    <option :value="person.id" v-for="person in persons">{{ person.name }}</option>                                            
                                                </select>
                                            </span>
                                            <span class="icon is-small is-left">
                                                <i class="fas fa-user"></i>
                                            </span>                                    
                                        </p>
                                    </div>                                  
                                </div>

                                <div class="column is-paddingless is-1">                                                                       
                                </div>
                            </div>   
                            
                            <div class="meal-chef-row columns is-mobile is-marginless">                                
                                
                                <div class="column is-paddingless is-1" >                                    
                                </div>
                            
                                <div class="column is-paddingless is-10" >
                                    <div class="field has-addons">
                                        <div class="control is-expanded">
                                            <p class="control has-icons-left is-fullwidth">
                                                <input class="input" type="text" placeholder="Noter">
                                                <span class="icon is-small is-left">
                                                    <i class="fas fa-utensils"></i>
                                                </span>
                                            </p>
                                        </div>
                                        <div class="control">
                                            <button type="submit" class="button">
                                                <span class="icon is-small is-left">
                                                    <i class="fas fa-th"></i>
                                                </span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="column is-paddingless is-1">                                                                      
                                </div>
                            </div>
                        </div>

                        <div class="box meal-reservation-group" v-for="group in commonMeal.registrationGroups">
                            
                            <div class="meal-reservation-row columns is-mobile is-marginless" v-for="(registration, index) in group.registrations" :class="calcMealRowClass(registration.regNo)">
                                <div class="column is-paddingless is-1" >
                                    <span v-show="registration.attending" class="icon is-small" style="vertical-align:text-bottom;">
                                          <i class="fas fa-check-circle"></i>
                                    </span>
                                </div>							
                                
                                <div class="column is-4 is-paddingless">								
                                    {{ registration.personName }}							
                                </div>                            
                                
                                <div class="column is-7 is-paddingless">                                
                                    <!-- This level is need to keep the radio together in the column (so it doesn´t split line when resizing) -->
                                    <nav class="level">                                         
                                        <div class="level-left">
                                            <div class="level-item">
                                                <div class="control">
                                                    <label class="radio">
                                                        <input type="radio" :value="true" :name="registration.id" v-model="registration.attending" @change="saveRegistration(registration)" >
                                                        Ja
                                                    </label>
                                                    <label class="radio">
                                                        <input type="radio" :value="false" :name="registration.id" v-model="registration.attending" @change="saveRegistration(registration)">
                                                        Nej
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </nav>                                
                                </div>
                            </div>
                        </div>                                                   
                    </div>
                </div>               
            </div>
        </div> 
      </section>
    </div>

    <script type="text/javascript">
      var webstore = new Vue({
        el: '#app',
        methods: {
            previous() {
                var date = this.commonMeals[0].date;
                axios
                    .get(`${baseApiUrl}/commonmeal/commonmeals/previous`, 
                        {
                            params: { mealDate : date }
                        }
                    )
                    .then(response => {                    
                        this.commonMeals = response.data.meals;
                        this.pageSubtitle = response.data.title;                        
                    })
                    .catch(e => {
                        alert("Error fetch previous meals: " + e)
                            console.log(e);
                    })
            },
            next() {
                var date = this.commonMeals[0].date;
                axios
                    .get(`${baseApiUrl}/commonmeal/commonmeals/next`, 
                        {
                                params : { mealDate : date }
                        }
                    )
                    .then(response => {                    
                        this.commonMeals = response.data.meals;
                        this.pageSubtitle = response.data.title;                      
                    })
                    .catch(e => {
                        alert("Error fetch next meals: " + e)
                            console.log(e);
                    })
            },
            calcMealRowClass(regNo) {
                return (regNo % 2 == 0) ? "meal-reservation-row-even" : "meal-reservation-row-odd";                
            },
            calcMealTitleClass(chefs) {
                return chefs.every(x => x.personId != null) 
                    ? "meal-chefs-ok" 
                    : chefs.some(x => x.personId != null) ? "meal-chefs-missingsome" : "";
            },
            calcChefClass(chef) {
                console.log("A: " + chef.personId);
                return chef.personId != null ? ["meal-chef-ok", "fa-check"] : "fa-user";
            },
            saveRegistration(registration) {                
                axios
                    .put(`${baseApiUrl}/commonmeal/registrations`, registration)
                    .then(response => {
                        console.log("Saved registration: " + registration.id);
                    })                
                    .catch(e => {
                        alert("Error saving registration: " + e)
                        console.log(e);
                    })
            },
            saveChef(chef) {
                axios
                    .put(`${baseApiUrl}/commonmeal/chefs`, chef)
                    .then(response => {
                        console.log("Saved chef: " + chef.id + " personId: " + chef.personId);
                    })                   
                    .catch(e => {
                        alert("Error saving chef: " + e)
                        console.log(e);
                    })                    
            },            
        },
        created() {
            axios
                .get(`${baseApiUrl}/commonmeal/commonmeals`)
                .then(response => {                    
                    this.commonMeals = response.data.meals;
                    this.persons = response.data.persons;
                    this.pageSubtitle = response.data.title;
                })
                .catch(e => {
                    alert("Error fetch data: " + e)
                        console.log(e);
                })
        }
        
        ,
        data: {            
            pageTitle: "Buske bofælleskab",
            pageSubtitle : "Fællesspisning",        
            commonMeals: [],
            persons: []
        } 
      });
    </script>
  </body>
</html>
